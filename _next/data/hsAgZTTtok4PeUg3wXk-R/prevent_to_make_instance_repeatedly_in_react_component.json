{"pageProps":{"title":"Prevent to make instance repeatedly in react component","date":"Dec 15, 2021","tag":["React","Issue"],"excerpt":"I had an issue to make instance repeatedly in react component, and fixed it.","content":"\nAll code is not real codes, but abstracted to understand this issue easily.\n\n```javascript\n// service/command.ts\nexport default class Command {\n  contentsContainer: HTMLDivElement;\n  posts: Post[];\n  curDir: string;\n\n  constructor(contentsContainer: HTMLDivElement, posts: Post[]) {\n    this.contentsContainer = contentsContainer;\n    this.posts = posts;\n    this.curDir = \"\";\n  }\n\n  cd() {\n    switch (this.curDir) {\n      case \"\":\n        this.curDir = \"/dir\";\n        break;\n\n      case \"/dir\":\n        this.curDir = \"\";\n        break;\n    }\n  }\n}\n\n// pages/cli.tsx\nexport default function Cli({ posts }: IProps) {\n\n  const [curDir, setCurDir] = useState(\"\");\n\n  const contentsElement = useRef<HTMLDivElement>(null);\n  const contentsContainer = contentsElement.current!;\n\n  const cliCommand = new Command(contentsContainer, posts);\n\n  const changeDirectory = () => {\n      cliCommand.cd(command);\n      setCurDir(cliCommand.curDir);\n  };\n  return (\n      ...\n  );\n}\n\nexport const getStaticProps: GetStaticProps = async () => {\n  const posts = getBlogList();\n  return {\n    props: {\n      posts,\n    },\n  };\n};\n\n```\n\nThis code is to implement cli command for my tech blog. It works well in unit testing, but I had an issue when user testing. Even if I change this.curDir member in cliCommand instance to the string \"/dir\", it keep changing to an empty string again.\n\nThe reason was the react component keep making new instance whenever the life cycle of itself was changed. I set the member, this.curDir, the empty string in constructor method, so it kept changing to empty string.\n\nI wanted to make an instance of Command class in the main component, \\_app.tsx, then inject the dependency into cli page component, but I can not access the arguments for constructor method, HTMLDivElement, and pages, in the main component. Because the business logic of getting pages need to access file system, but the main component of next.js was not supported for server-side.\n\n```javascript\n\n// service/command.ts\nexport default class Command {\n  contentsContainer!: HTMLDivElement;\n  posts!: Post[];\n  curDir: string;\n\n  constructor() {\n    this.curDir = \"\";\n  }\n\n  init(contentsContainer: HTMLDivElement, posts: Post[]) {\n    this.contentsContainer = contentsContainer;\n    this.posts = posts;\n  }\n\n  cd() {\n    switch (this.curDir) {\n      case \"\":\n        this.curDir = \"/dir\";\n        break;\n\n      case \"/dir\":\n        this.curDir = \"\";\n        break;\n    }\n  }\n}\n\n\n// pages/_app.tsx\nimport Command from \"../service/blog/command\";\n\nfunction MyApp({ Component, pageProps }: AppProps) {\n  const cliCommand = new Command();\n  return <Component {...pageProps} cliCommand={cliCommand} />\n}\n\nexport default MyApp;\n\n\n// pages/cli.tsx\nexport default function Cli({ cliCommand, posts }: IProps) {\n\n  const [curDir, setCurDir] = useState(\"\");\n\n  const contentsElement = useRef<HTMLDivElement>(null);\n  const contentsContainer = contentsElement.current!;\n\n  const changeDirectory = () => {\n      cliCommand.cd(command);\n      setCurDir(cliCommand.curDir);\n  };\n\n useEffect(() => {\n    cliCommand.init(contentsContainer, posts);\n  }, [contentsContainer, posts]);\n\n  return (\n      ...\n  );\n}\n\nexport const getStaticProps: GetStaticProps = async () => {\n  const posts = getBlogList();\n  return {\n    props: {\n      posts,\n    },\n  };\n};\n\n```\n\nTo figure it out, I removed all the arguments from the constructor method, and added an init method to set HTMLDivElement and pages members. Then I made an instance in main component, and pass it to the page component.\n"},"__N_SSG":true}