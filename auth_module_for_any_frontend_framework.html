<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Auth Module for any frontend framework - WayneChoi.dev</title><meta name="author" content="Wayne Choi"/><meta name="description" content="I implemented a framework free frontend authentication module with TypeScript."/><meta name="keywords" content="TypeScript,Authentication"/><meta name="next-head-count" content="6"/><link rel="preload" href="https://waynechoi.dev/_next/static/css/dd81c86663b99a7f14a1.css" as="style"/><link rel="stylesheet" href="https://waynechoi.dev/_next/static/css/dd81c86663b99a7f14a1.css" data-n-g=""/><link rel="preload" href="https://waynechoi.dev/_next/static/css/81065f7f6327d4b5d267.css" as="style"/><link rel="stylesheet" href="https://waynechoi.dev/_next/static/css/81065f7f6327d4b5d267.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="https://waynechoi.dev/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="https://waynechoi.dev/_next/static/chunks/webpack-26d4ba47f3aad1b49b1b.js" defer=""></script><script src="https://waynechoi.dev/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="https://waynechoi.dev/_next/static/chunks/main-c4f2541b93e4ae8b71f8.js" defer=""></script><script src="https://waynechoi.dev/_next/static/chunks/pages/_app-e0ee6ffbfc44e952c6f7.js" defer=""></script><script src="https://waynechoi.dev/_next/static/chunks/113-578803495dd2b122acd7.js" defer=""></script><script src="https://waynechoi.dev/_next/static/chunks/pages/%5Bslug%5D-359e4aa19627ad0c9516.js" defer=""></script><script src="https://waynechoi.dev/_next/static/f3qpXa1WNAjLLX98N6eNA/_buildManifest.js" defer=""></script><script src="https://waynechoi.dev/_next/static/f3qpXa1WNAjLLX98N6eNA/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="style_container__1fUIW"><header class="style_header__1vTJ4 theme_light__2lu4I"><div class="style_container__3a_wR"><div class="style_header__1ynE4"><button class="style_mobileMenuButton__1APOa"><img alt="open_menu_bar" src="https://waynechoi.dev/images/menu.svg"/></button><a class="style_name__c3MEE" href="/">WayneChoi.dev</a><ul class="style_list__chEFJ"><li><div><a href="/">HOME</a></div></li><li><div><a href="/about">ABOUT</a></div></li><li><div><a href="/portfolio">PORTFOLIO</a></div></li><li><div><a href="/cv" target="_blank">CV</a></div></li><li><button class="style_cliButton__3JcSL"><img src="https://waynechoi.dev/images/cli.png" alt="cli_mode"/></button></li></ul><div class="style_searchBar__FDBv7"><form class="style_container__j4rCB theme_light__2lu4I"><input type="text" id="keyword" placeholder="keywords..." required="" class="theme_light__2lu4I"/><button type="submit"><img alt="search" src="https://waynechoi.dev/images/search.svg"/></button></form></div><button class="style_mobileSearchButton__1AMGz"><img alt="open_search_bar" src="https://waynechoi.dev/images/search.svg"/></button></div></div></header><section class="style_contents__1dCqS"><div class="blog_container__2sPBE"><div class="blog_tagWrapper__1MSFu"><span class="blog_tag__3CYz_">#<!-- -->TypeScript</span><span class="blog_tag__3CYz_">#<!-- -->Authentication</span></div><h1 class="blog_h1__3a0RO">Auth Module for any frontend framework</h1><span class="blog_date__3Pnjx">Mar 29, 2022</span><div class="blog_content__2NI78"><div class="style_container__2jJTZ"></div></div></div></section><footer class="style_footer__1H40h">(C) <!-- -->2022<!-- -->. Wonjun Choi. All rights reserved.</footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"Auth Module for any frontend framework","date":"Mar 29, 2022","tag":["TypeScript","Authentication"],"excerpt":"I implemented a framework free frontend authentication module with TypeScript.","content":"\nI implemented an authentication module, and it is not dependent to any framework or library. It is made with TS class, so it has its own status. I injected all the dependency to update state of frontend framework, and local storage.\n\nI described in more detail why I used classes rather than functions, in the link below.\n\n[\"State management with Class in React\"](https://waynechoi.dev/state_management_with_class_in_react)\n\n## Singleton pattern\n\nThe class of this module should be initialized only once in an application. Otherwise, it could not be guaranteed to cause unintended change of status. For example, if I create an instance with constructor method on main component of React, the constructor method could be called multiple times from re-rendering the component. (I met this issue that the main component when I wrap the main component of React with RecoilRoot component of Recoil library) So I chose singleton pattern to create only one instance.\n\n```typescript\nexport default class AuthService {\n  static _instance: AuthService;\n\n  private constructor() {}\n\n  public static getInstance() {\n    return this._instance || (this._instance = new this());\n  }\n}\n```\n\n## Initialize\n\ninit() method is to inject dependencies and initialize status, and local storage.\nI injected URL Base for API endpoint, window object to manage local storage, date object, and a function to update framework level status.\n\n```typescript\nexport default class AuthService {\n  // skip\n\n  private urlBase!: string;\n  private date!: Date;\n  private setStatus!: Function;\n  private window!: Window;\n\n  public async init(\n    urlBase: string,\n    window: Window,\n    date: Date,\n    setStatus: Function\n  ) {\n    this.urlBase = urlBase;\n    this.setStatus = setStatus;\n    this.window = window;\n    this.date = date;\n  }\n}\n```\n\n## Sign In\n\nsignIn() method is to sign in. It sends a request with user information, and get a response from backend API server. Its parameters are username, password, and isChecked. isChecked is a boolean. User information is stored in local storage if it is true, but session storage if it is false.\n\nIt branch out according to the status code of the response. If it is not 2xx, it returns an error message. If it is 2xx, it calls three private methods.\n\nsetMembersFromResponse() is to set members with user information from the response. this.stored is for which storage to store.\n\nsetStorageFromMembers() is to set local storage or session storage with user information from members of the class.\n\nupdate() is to set token to status of external library with setStatus which is injected dependency in init() method.\n\n```typescript\ntype SignInResult = {\n  message?: string;\n  accessToken: string;\n  refreshToken: string;\n  expiredTime: string;\n  userId: string;\n};\n\nexport type AuthStatus = {\n  token: string;\n  isAuth: \"yes\" | \"no\" | \"\";\n};\n\nexport default class AuthService {\n  // skip\n\n  private accessToken?: string;\n  private refreshToken?: string;\n  private expiredTime?: string;\n  private userId?: string;\n  private stored?: \"localStorage\" | \"sessionStorage\";\n  private isAuth?: \"yes\" | \"no\" | \"\";\n\n  public async signIn(\n    username: string,\n    password: string,\n    isChecked: boolean\n  ): Promise\u003cstring | undefined\u003e {\n    const myHeaders = new Headers();\n    myHeaders.append(\"Content-Type\", \"application/json\");\n\n    const requestOptions = {\n      method: \"POST\",\n      headers: myHeaders,\n      body: JSON.stringify({\n        username,\n        password,\n      }),\n    };\n\n    const response = await fetch(\n      `${this.urlBase}/auth/sign_in`,\n      requestOptions\n    );\n    const result: SignInResult = await response.json();\n    if (response.status \u003e 199 \u0026\u0026 response.status \u003c 300) {\n      this.setMembersFromResponse(result, isChecked);\n      this.setStorageFromMembers();\n      this.update();\n      return \"success\";\n    } else {\n      return result.message;\n    }\n  }\n\n  private setMembersFromResponse(result: SignInResult, isChecked?: boolean) {\n    this.accessToken = result.accessToken;\n    this.refreshToken = result.refreshToken;\n    this.expiredTime = result.expiredTime;\n    this.userId = result.userId;\n    if (typeof isChecked === \"boolean\") {\n      this.stored = isChecked ? \"localStorage\" : \"sessionStorage\";\n    }\n\n    this.isAuth = \"yes\";\n  }\n\n  private setStorageFromMembers() {\n    window.localStorage.setItem(\"stored\", this.stored!);\n    window[this.stored!].setItem(\"accessToken\", this.accessToken!);\n    window[this.stored!].setItem(\"refreshToken\", this.refreshToken!);\n    window[this.stored!].setItem(\"expiredTime\", this.expiredTime!);\n    window[this.stored!].setItem(\"userId\", this.userId!);\n  }\n\n  private update() {\n    const status: AuthStatus = {\n      token: this.accessToken!,\n      isAuth: this.isAuth!,\n    };\n    this.setStatus(status);\n  }\n}\n```\n\n## Sign Out\n\nsignOut() method is to sign out. It get which storage the user information is stored in, and clean local or session storage and members about user information. Then it calls update() method to update the status of external library.\n\n```typescript\n// skip\n\nexport default class AuthService {\n  // skip\n\n  public signOut() {\n    const storage = this.window.localStorage.getItem(\"stored\")\n      ? \"localStorage\"\n      : \"sessionStorage\";\n\n    this.window[storage].removeItem(\"accessToken\");\n    this.window[storage].removeItem(\"refreshToken\");\n    this.window[storage].removeItem(\"expiredTime\");\n    this.window[storage].removeItem(\"userId\");\n    this.window.localStorage.removeItem(\"stored\");\n\n    this.accessToken = undefined;\n    this.refreshToken = undefined;\n    this.expiredTime = undefined;\n    this.userId = undefined;\n    this.isAuth = \"no\";\n    this.update();\n  }\n}\n```\n\n## Getter method of user id\n\ngetUserId() method is a getter method to return userId member.\n\n```typescript\n// skip\n\nexport default class AuthService {\n  // skip\n\n  public getUserId() {\n    return this.userId;\n  }\n}\n```\n\n## Initialize after signing in\n\nI add some more logic in the init() method. After all dependency injection, I set members from local or session storage with setMembersFromStorage() the private method.\n\nIt checks expired time of access token with isAccessTokenExpired() the private method. If its access token is expired, it send a request with a refresh token to re-issue access token. reIssueToken() method got a same branching process of signIn() method.\n\nThen it updates the status of external library.\n\n```typescript\n// skip\n\nexport default class AuthService {\n  // skip\n\n  public async init(urlBase: string, window: Window, date: Date, setStatus: Function) {\n    // skip\n\n    this.setMembersFromStorage();\n\n    if (this.expiredTime) {\n      const isAuth = !this.isAccessTokenExpired(this.expiredTime);\n      // if it is expired, it is not authorized.\n      if (isAuth) {\n        this.isAuth = 'yes';\n        this.update();\n      } else {\n        await this.reIssueToken(this.userId!, this.refreshToken!);\n      }\n    } else {\n      this.isAuth = 'no';\n      this.update();\n    }\n    //skip\n\n  private setMembersFromStorage() {\n    const storage =\n      window.localStorage.getItem('stored') === 'localStorage' ? 'localStorage' : 'sessionStorage';\n\n    this.stored = storage;\n    this.accessToken = window[storage].getItem('accessToken')!;\n    this.refreshToken = window[storage].getItem('refreshToken')!;\n    this.expiredTime = window[storage].getItem('expiredTime')!;\n    this.userId = window[storage].getItem('userId')!;\n  }\n\n  private async reIssueToken(userId: string, refreshToken: string): Promise\u003cvoid\u003e {\n    const myHeaders = new Headers();\n    myHeaders.append('Content-Type', 'application/json');\n\n    const requestOptions = {\n      method: 'POST',\n      headers: myHeaders,\n      body: JSON.stringify({\n        userId,\n        refreshToken,\n      }),\n    };\n    const response = await fetch(`${this.urlBase}/auth/reissue_token`, requestOptions);\n    const result: SignInResult = await response.json();\n    if (response.status \u003e 199 \u0026\u0026 response.status \u003c 300) {\n      this.setMembersFromResponse(result);\n      this.setStorageFromMembers();\n      this.update();\n    } else {\n      this.signOut();\n    }\n  }\n\n  private isAccessTokenExpired(expiredTime: string) {\n    if (this.date!.getTime() \u003e= parseInt(expiredTime)) {\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n}\n```\n\n## To be fixed\n\nThe branching process to figure out which local storage to save user information is abstracted with private methods. So It is hard to be tested. The test coverage of this service is about 80% now.\n\nI guess I could decouple this process with another class or static class.\n"},"__N_SSG":true},"page":"/[slug]","query":{"slug":"auth_module_for_any_frontend_framework"},"buildId":"f3qpXa1WNAjLLX98N6eNA","assetPrefix":"https://waynechoi.dev","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>